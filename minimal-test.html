<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal MutationObserver StyleSheet Test</title>
    <!-- Style will be added dynamically -->
</head>
<body>
    <h1>Minimal MutationObserver StyleSheet Test</h1>
    <p>Open DevTools Console to see results</p>
    <button onclick="createStylesheet()">1. Create Dynamic Stylesheet</button>
    <button onclick="addRule()" id="add-btn" disabled>2. Add CSS Rule</button>
    <button onclick="removeRule()" id="remove-btn" disabled>3. Remove CSS Rule</button>

    <script>
        let styleElement, stylesheet, observer;
        let ruleCounter = 0;
        
        function createStylesheet() {
            // Create style element dynamically
            styleElement = document.createElement('style');
            styleElement.id = 'test-style';
            styleElement.innerText = '.test { color: red; }';
            
            // Add to document
            document.head.appendChild(styleElement);
            stylesheet = styleElement.sheet;
            
            console.log('‚úÖ Dynamic stylesheet created');
            console.log('Browser:', navigator.userAgent);
            console.log('Initial rules count:', stylesheet.cssRules.length);
            
            // Set up MutationObserver on the stylesheet
            observer = new MutationObserver((mutations) => {
                console.log('üî• MutationObserver fired!', mutations);
                mutations.forEach(mutation => {
                    console.log('  Mutation type:', mutation.type);
                    console.log('  Added nodes:', mutation.addedNodes.length);
                    console.log('  Removed nodes:', mutation.removedNodes.length);
                });
            });
            
            try {
                // This is the problematic line in Firefox
                observer.observe(stylesheet, { childList: true });
                console.log('‚úÖ MutationObserver successfully observing dynamic stylesheet');
            } catch (error) {
                console.error('‚ùå Failed to observe stylesheet:', error);
            }
            
            // Enable test buttons
            document.getElementById('add-btn').disabled = false;
            document.getElementById('remove-btn').disabled = false;
            event.target.disabled = true;
            event.target.textContent = '‚úÖ Stylesheet Created';
            
            console.log('Ready! Click buttons to test...');
        }
        
        function addRule() {
            if (!stylesheet) return;
            const rule = `.dynamic-${++ruleCounter} { color: blue; }`;
            stylesheet.insertRule(rule, stylesheet.cssRules.length);
            console.log('Added rule:', rule);
            console.log('New rules count:', stylesheet.cssRules.length);
        }
        
        function removeRule() {
            if (!stylesheet || stylesheet.cssRules.length <= 1) return;
            const removedRule = stylesheet.cssRules[stylesheet.cssRules.length - 1].cssText;
            stylesheet.deleteRule(stylesheet.cssRules.length - 1);
            console.log('Removed rule:', removedRule);
            console.log('New rules count:', stylesheet.cssRules.length);
        }
        
        console.log('Click "Create Dynamic Stylesheet" to start testing...');
    </script>
</body>
</html>
